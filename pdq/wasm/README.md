PDQ, MD5 and TMK Hashing with Web Assembly
---------------------------------------------------

PREAMBLE:
=========
This document describes the method to get the PDQ, MD5 and TMK Hashing of content using Web Assembly (WASM) in a client browser, without uploading the content to any server.  This Web Assembly is built on the ThreatExchange Open source released by Meta, Inc., The WASM is built with some modifications to the C++ code released in ThreatExchange, and built using emscripten tool, The test scripts for this are implemented using Microsoft .NET 6.0, and is verified to run under both Windows and as well Linux platforms.  
There are some images included in this package, and they are provided only for Open-Source testing only and cannot be used for any other purposes, other than the testing of this code.  Appropriate authorizations and licenses must be obtained for any other purposes.
There two Web Assemblies included in this package, one to create hashes based on PDQ and MD5.  PDQ hashes are used for photos (like Jpeg, gif, tiff, png etc.).  All other files are by default hashed using MD5 hashing method only.  Videos files of type such as mp4, mov, wmv can be hashed using TMK algorithms.
Binaries relating to Web Assembly and Testing programs are built with the steps in this document.  The binaries included in this package are available elsewhere under secure open-source access, and the user is free to get those libraries and executables from respective sources with appropriate checksum verifications.  

PREREQUISITES
=============
Following are the prerequisites to get the source built and get it running:
1.	Docker: Docker or Docker-Desktop (Windows) is required to build the source code for creating the Web Assembly.  Instead of downloading, building and running emscripten in a local environment, which can be complex, 
2.	.NET 6.0 environment:  This can be easily setup in Windows, Linux or MacOS environments. The user can either install the SDK version which includes runtime or simply the runtime.  Complete documentation on how to set up .NET 66.0 and tools is available at: 
a.	Windows: https://docs.microsoft.com/en-us/dotnet/core/install/windows?tabs=net60 
b.	Ubuntu: https://docs.microsoft.com/en-us/dotnet/core/install/linux-ubuntu 
c.	MacOS: https://docs.microsoft.com/en-us/dotnet/core/install/macos 
3.	.NET 6.0 CLI Tools: This is required for running the test scripts included in the package. Complete details on how to install this is available at: 
a.	https://docs.microsoft.com/en-us/dotnet/core/tools/ 
4.	node:  This is required to run the test scripts on a node server.  There are also few packages that need to be imported and they are in the areas of ImageMagick (For image analysis), few video encoder/decoders such as ffmpeg .  
5.	Firefox or Chrome Browser.  This is required to open the .js (JavaScript) file generated by the Web Assembly build along with the WASM file.  By default, the Chrome driver is automatically imported along the test run into its Resources.  However the user desires to run on Firefox, the user must first download the "gecko" seleniuim driver from the Github (ttps://github.com/mozilla/geckodriver/releases) and place it under the /tmp/ThreatExcahnge/pdq/wasm/test/WebAssemblySeleniumWebDriver/WebAssemblySeleniumWebDriver/Resources/Drivers/Firefox directory. 
6.	If there is no hosting environment available to host the .js file and .wasm file, then node package is required to run the JavaScript file.  This document describes the steps for getting the Web Assembly running under the node server.  Similar steps can be performed on other Web Servers as well. 
7.	The testing scripts can be run using a command window only and no GUI environment is required. 
8.	The binaries (libraries or executables) included are from the following sources:
a.	Microsoft: .NET specific libraries.  Please refer to the libraries under test drivers/scripts directory.
b.	Selenium Drivers: To run the test scripts, since the browser must be invoked to perform the test scripts
c.	Browser drivers: Chrome Drivers and Gecko Drivers (Firefox drivers)
9.	Software code for this entire project: <<Need to be filled >>
10.	For the remainder of this document, it is assumed that the downloaded code is in /tmp/.


PDQ / MD5 WEB ASSEMBLY 
=======================
STEPS FOR BUILDING THE PDQ / MD5 WEB ASSEMBLY:
----------------------------------------------
Note: There is a Makefile provided under the /tmp/ThreatExchange/pdq/wasm directory, which can automate all the steps provided below:

The steps are:
1.	Pull the emscripten docker image using the following command. (The reference for this available at https://hub.docker.com/r/emscripten/emsdk : 
docker pull emscripten/emsdk:3.1.7

2.	Run the below docker commands for compiling the code to web assembly:
docker run --rm -v /tmp/ThreatExchange:/src emscripten/emsdk:3.1.7 emmake make wasm --directory=pdq/cpp

3.	Once the command successfully completed, two files are created in the directory /tmp/ThreatExchange/pdq/cpp with the file extensions: .wasm and .js.

STEPS FOR RUNNING THE TESTS FOR PDQ / MD5 WEB ASSEMBLY:
The tests for these web assembly are run using the Selenium Test Drivers. This is because, the invocation of browsers and operating the browser as if an user is interacting through the browser to generate the hashes locally, instead of uploading it.  The test program is built using Microsoft .NET 6.0 Core and can be run on Windows, MacOS and Linux environments.  The steps for building and running the tests are:
1.	Make sure all prerequisites are installed in the environment that runs the tests. The prerequisites are described above.

2.	Copy the pdq-photo-hasher.js and pdq-photo-hasher.wasm files generated in the previous section to /tmp/ThreatExchange/pdq/wasm/scripts folder.

3.	Navigate to the folder /tmp/ThreatExchange/pdq/wasm and open a command window in that directory.

4.	Run npm install in the /tmp/ThreatExchange/pdq/wasm directory to make sure that necessary node modules are installed.

5.	Edit the file named server.js, which is used by node server.  In Line 5, a port number is specified for running the node web server.  [For the document purpose, we will assume that it is 9095]

6.	Once the editing is complete, run the node server by using the following command:
node server.js

7.	Navigate to /tmp/ThreatExcahnge/pdq/wasm/test/WebAssemblySeleniumWebDriver/WebAssemblySeleniumWebDriver folder.

8.	Open a Command window and run the following command:
dotnet build

9.	The build process will successfully create executables under the directory: bin/Debug/net6.0 directory.

10.	The test data is provided through the file named: PDQMD5TestData.csv under the directory /tmp/ThreatExchange/pdq/wasm/test/TestData.  Please make sure that file paths are correct for the image files in that PDQMD5TestData.csv .  if not adjust the paths appropriately for each image file.

11.	Now, run the test script driver using the following command:
dotnet run chrome pdqmd5 /tmp/ThreatExchange/pdq/wasm/test/TestData/PDQMD5TestData.csv http://localhost:9095

The arguments for this command are provided below in the table:
Argument Position	Description	Possible Values
Arg 1	The name of the Browser Driver.	chrome , firefox
Arg 2	Specifies the type of Hash to be calculated	pdqmd5 , tmk
Arg 3	Specifies the location of the file where test data is available. 	Filename with path
Arg 4	Specifies the URL that runs the .js file and .wasm file. Specified in Step 5 above. A Valid URL.

12.	If the tests are successful, the messages for all images display as “hash matching”. 
------------------------------------------------------------------------------------------------------

TMK WEB ASSEMBLY 
=================
STEPS FOR BUILDING THE TMK WEB ASSEMBLY:
---------------------------------------
Note: There is a Makefile provided under the /tmp/ThreatExchange/tmk/wasm direcotry, which can automate all the steps provided below:

The steps are:
1.	Pull the emscripten docker image using the following command. (The reference for this available at https://hub.docker.com/r/emscripten/emsdk : 
docker pull emscripten/emsdk:3.1.7

2.	Run the below docker commands for compiling the code to web assembly:
docker run --rm -v /tmp/ThreatExchange:/src emscripten/emsdk:3.1.7 emmake make wasm --directory=tmk/cpp

3.	Once the command successfully completed, two files are created in the directory /tmp/ThreatExchange/tmk/cpp with the file extensions: .wasm and .js.

STEPS FOR RUNNING THE TESTS FOR PDQ / MD5 WEB ASSEMBLY:
The tests for these web assembly are run using the Selenium Test Drivers. This is because, the invocation of browsers and operating the browser as if an user is interacting through the browser to generate the hashes locally, instead of uploading it.  The test program is built using Microsoft .NET 6.0 Core and can be run easily on Windows, MacOS and Linux environments.  The steps for building and running the tests are:
1.	Make sure all prerequisites are installed in the environment that runs the tests. The prerequisites are described above.

2.	Copy the tmk-hash-video.js and tmk-hash-video.wasm files generated in the previous section to /tmp/ThreatExchange/tmk/wasm/scripts folder.

3.	Navigate to the folder /tmp/ThreatExchange/tmk/wasm and open a command window in that directory.

4.	Run npm install in the /tmp/ThreatExchange/tmk/wasm directory to make sure that necessary node modules are installed.

5.	Edit the file named server.js, which is used by node server.  In Line 5, a port number is specified for running the node web server.  [For the document purpose, we will assume that it is 9096]

6.	Once the editing is complete, run the node server by using the following command:
node server.js

7.	Navigate to /tmp/ThreatExchange/tmk/wasm/test/WebAssemblySeleniumWebDriver/WebAssemblySeleniumWebDriver folder.

8.	Open a Command window and run the following command:
dotnet build

9.	The build process will successfully create executables under the directory: bin/Debug/net6.0 directory.

10.	The test data is provided through the file named: TMKTestData.csv under the directory /tmp/ThreatExchange/tmk/wasm/test/TestData.  Please make sure that file paths are correct for the image files in that TMKTestData.csv .  if not adjust the paths appropriately for each image file.

11.	Now, run the test script driver using the following command:
dotnet run chrome tmk /tmp/ThreatExchange/tmk/wasm/test/TestData/TMKTestData.csv /tmp/testdata http://localhost:9096

The arguments for this command are provided below in the table: (all arguments are required)
Argument Position	Description	Possible Values
Arg 1	The name of the Browser Driver.	chrome , firefox
Arg 2	Specifies the type of Hash to be calculated	pdqmd5  , tmk
Arg 3	Specifies the location of the file where test data is available. 	Filename with path
Arg 4	Specifies the location where temporary tmk and video files are stored during the hash generation process .  	File location that must already exist.
Arg 5	Specifies the URL that runs the .js file and .wasm file. Specified in Step 5 above. 	A Valid URL.

12.	If the tests are successful, the messages for all images display as “hash matching”.


